openapi: 3.0.3
info:
  title: MiniStrava API
  version: 1.0.0
  description: Complete and professional fitness tracking API.
servers:
  - url: /api

security:
  - bearerAuth: []

tags:
  - name: Auth
  - name: User
  - name: Profiles
  - name: Activities
  - name: Leaderboard
  - name: Push Tokens

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Sanctum

  schemas:
    # === [AUTH SCHEMAS] ===
    Auth:ChangePasswordRequest:
      type: object
      required: [current_password, password, password_confirmation]
      properties:
        current_password: { type: string }
        password: { type: string, minLength: 8 }
        password_confirmation: { type: string, minLength: 8 }

    Auth:ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email: { type: string, format: email }

    Auth:LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }

    Auth:RegisterRequest:
      type: object
      required: [name, email, password, password_confirmation]
      properties:
        name: { type: string, maxLength: 255 }
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        password_confirmation: { type: string, minLength: 8 }

    Auth:ResetPasswordRequest:
      type: object
      required: [token, email, password, password_confirmation]
      properties:
        token: { type: string }
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        password_confirmation: { type: string, minLength: 8 }

    # === [USER & PROFILE SCHEMAS] ===
    User:Profile:
      type: object
      properties:
        id: { type: integer }
        email: { type: string, format: email }
        name: { type: string }
        first_name: { type: string, nullable: true }
        last_name: { type: string, nullable: true }
        birth_date: { type: string, format: date, nullable: true }
        height: { type: integer, nullable: true }
        weight: { type: number, nullable: true }
        avatar: { type: string, nullable: true }
        created_at: { type: string, format: date-time }

    User:UpdateProfileRequest:
      type: object
      properties:
        first_name: { type: string, maxLength: 255, nullable: true }
        last_name: { type: string, maxLength: 255, nullable: true }
        birth_date: { type: string, format: date, nullable: true }
        height: { type: integer, minimum: 50, maximum: 300, nullable: true }
        weight: { type: number, minimum: 10, maximum: 300, nullable: true }
        gender: { type: string, enum: [male, female], nullable: true }

    # === [ACTIVITY SCHEMAS] ===
    Activity:Base:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        notes: { type: string, nullable: true }
        activity_type: { type: string, enum: [run, ride, walk, other] }
        duration_s: { type: integer }
        distance_m: { type: integer }
        photo: { type: string, nullable: true }
        started_at: { type: string, format: date-time }
        gps_points:
          type: array
          items: { $ref: '#/components/schemas/Activity:GpsPoint' }

    Activity:GpsPoint:
      type: object
      required: [lat, lng, timestamp]
      properties:
        lat: { type: number }
        lng: { type: number }
        alt_m: { type: number, nullable: true }
        accuracy_m: { type: number, nullable: true }
        timestamp: { type: integer }

    Activity:StoreRequest:
      type: object
      required: [title, duration_s, distance_m, started_at, activity_type]
      properties:
        title: { type: string, maxLength: 255 }
        notes: { type: string, maxLength: 2048, nullable: true }
        duration_s: { type: integer, minimum: 1 }
        distance_m: { type: integer, minimum: 1 }
        started_at: { type: string, format: date-time }
        activity_type: { type: string, enum: [run, ride, walk, other] }
        photo: { type: string, format: binary, nullable: true }
        gps_points:
          type: array
          items: { $ref: '#/components/schemas/Activity:GpsPoint' }

    # === [STATS & LEADERBOARD] ===
    Stats:Statistics:
      type: object
      properties:
        activitiesCount: { type: integer }
        totalDistanceM: { type: integer }
        totalDurationS: { type: integer }
        avgDistanceM: { type: number }
        avgDurationS: { type: number }
        avgSpeedMps: { type: number }
        avgSpeedKph: { type: number }
        avgPaceSecPerKm: { type: number }
        longestDistanceM: { type: integer }
        longestDurationS: { type: integer }
        firstActivity: { type: string, format: date-time, nullable: true }
        lastActivity: { type: string, format: date-time, nullable: true }

    Stats:LeaderboardEntry:
      type: object
      properties:
        place: { type: integer }
        score: { type: integer }
        user: { $ref: '#/components/schemas/User:Profile' }

    # === [PUSH TOKENS] ===
    Push:TokenItem:
      type: object
      properties:
        id: { type: integer }
        platform: { type: string, enum: [android, ios, web] }
        device_id: { type: string, nullable: true }
        device_name: { type: string, nullable: true }
        last_used_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }

    Push:StoreRequest:
      type: object
      required: [token, platform]
      properties:
        token: { type: string, maxLength: 4096 }
        platform: { type: string, enum: [android, ios, web] }
        device_id: { type: string, maxLength: 255, nullable: true }
        device_name: { type: string, maxLength: 255, nullable: true }

    # === [RESPONSE WRAPPERS] ===
    Wrapper:User:
      type: object
      properties:
        data: { $ref: '#/components/schemas/User:Profile' }
    Wrapper:UserCollection:
      type: object
      properties:
        data: { type: array, items: { $ref: '#/components/schemas/User:Profile' } }
        links: { type: object, additionalProperties: true }
        meta: { type: object, additionalProperties: true }
    Wrapper:Activity:
      type: object
      properties:
        data: { $ref: '#/components/schemas/Activity:Base' }
    Wrapper:ActivityCollection:
      type: object
      properties:
        data: { type: array, items: { $ref: '#/components/schemas/Activity:Base' } }
    Wrapper:Statistics:
      type: object
      properties:
        data: { $ref: '#/components/schemas/Stats:Statistics' }
    Wrapper:Leaderboard:
      type: object
      properties:
        data: { type: array, items: { $ref: '#/components/schemas/Stats:LeaderboardEntry' } }
    Wrapper:PushTokens:
      type: object
      properties:
        ok: { type: boolean }
        data: { type: array, items: { $ref: '#/components/schemas/Push:TokenItem' } }
    Common:ValidationError:
      type: object
      properties:
        message: { type: string }
        errors: { type: object, additionalProperties: { type: array, items: { type: string } } }

paths:
  # --- AUTH ---
  /auth/login:
    post:
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Auth:LoginRequest' }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  user_id: { type: integer }

  /auth/register:
    post:
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Auth:RegisterRequest' }
      responses:
        "201":
          description: Created

  /auth/logout:
    post:
      tags: [Auth]
      responses:
        "200":
          description: OK

  /auth/forgot-password:
    post:
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Auth:ForgotPasswordRequest' }
      responses:
        "200":
          description: Email sent

  /auth/reset-password:
    post:
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Auth:ResetPasswordRequest' }
      responses:
        "200":
          description: OK

  # --- PROFILES & SOCIAL ---
  /profiles:
    get:
      tags: [Profiles]
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:UserCollection' }

  /profiles/{id}:
    get:
      tags: [Profiles]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User:Profile' }

  /profiles/{id}/statistics:
    get:
      tags: [Profiles]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:Statistics' }

  /profiles/{id}/avatar:
    get:
      tags: [Profiles]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            image/png: { schema: { type: string, format: binary } }

  /profiles/{id}/export:
    get:
      tags: [Profiles]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/gpx+xml: { schema: { type: string } }

  # --- MY PROFILE & USER ---
  /user:
    get:
      tags: [User]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User:Profile' }

  /user/change-password:
    post:
      tags: [User]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Auth:ChangePasswordRequest' }
      responses:
        "200":
          description: OK

  /profile:
    get:
      tags: [User]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:User' }
    patch:
      tags: [User]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/User:UpdateProfileRequest' }
      responses:
        "200":
          description: OK

  /profile/avatar:
    post:
      tags: [User]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [avatar]
              properties:
                avatar: { type: string, format: binary }
      responses:
        "200":
          description: OK
    delete:
      tags: [User]
      responses:
        "200":
          description: OK

  # --- ACTIVITIES ---
  /activities:
    get:
      tags: [Activities]
      parameters:
        - name: activity_type
          in: query
          schema: { type: string, enum: [run, ride, walk, other] }
        - name: date_from
          in: query
          schema: { type: string, format: date }
        - name: distance_min
          in: query
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:ActivityCollection' }
    post:
      tags: [Activities]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema: { $ref: '#/components/schemas/Activity:StoreRequest' }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:Activity' }

  /activities/{id}:
    get:
      tags: [Activities]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:Activity' }

  /activities/{id}/photo:
    get:
      tags: [Activities]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            image/png: { schema: { type: string, format: binary } }

  /activities/{id}/export:
    get:
      tags: [Activities]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/gpx+xml: { schema: { type: string } }

  # --- LEADERBOARD ---
  /leaderboard/{type}:
    get:
      tags: [Leaderboard]
      parameters:
        - name: type
          in: path
          required: true
          schema: { type: string, enum: [distance, duration] }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 200 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:Leaderboard' }

  # --- PUSH TOKENS ---
  /push-tokens:
    get:
      tags: [Push Tokens]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Wrapper:PushTokens' }
    post:
      tags: [Push Tokens]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Push:StoreRequest' }
      responses:
        "200":
          description: OK
    delete:
      tags: [Push Tokens]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token: { type: string }
      responses:
        "200":
          description: OK
